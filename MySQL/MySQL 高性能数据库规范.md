# MySQL 高性能数据库规范

## 数据库基本设计规范

1. 所有表必须使用 `Innodb` 存储引擎

2. 数据库和表的字符集统一使用 `utf8mb4`；数据库的 `Collation` 为 `utf8mb4_unicode_ci`

3. 所有表和字段都需要添加注释

4. 尽量控制单表数据量的大小,建议控制在 500 万以内

5. 谨慎使用 `MySQL` 分区表

    - 分区表在物理上表现为多个文件，在逻辑上表现为一个表；
    - 谨慎选择分区键，跨分区查询效率可能更低；
    - 建议采用物理分表的方式管理大数据。

6. 尽量做到冷热数据分离,减小表的宽度

   > `MySQL` 限制每个表最多存储 4096 列，并且每一行数据的大小不能超过 65535 字节。

    - 减少磁盘 IO,保证热数据的内存缓存命中率（表越宽，把表装载进内存缓冲池时所占用的内存也就越大,也会消耗更多的 IO）；
    - 更有效的利用缓存，避免读入无用的冷数据；
    - 经常一起使用的列放到一个表中（避免更多的关联操作）。

7. 禁止在数据库中存储图片,文件等大的二进制数据

   > 通常文件很大，会短时间内造成数据量快速增长，数据库进行数据库读取时，通常会进行大量的随机 IO 操作，文件很大时，IO 操作很耗时。

    - 通常存储于文件服务器，数据库只存储文件地址信息

8. 禁止在线上做数据库压力测试

9. 禁止从开发环境,测试环境直接连接生成环境数据库

10. 每张表必须含有 `id`、`created_at`、`updated_at`，如果有软删除，则增加 `deleted_at`。所有时间类型的字段，以 `_at` 结尾。

## 数据库命名规范

1. 所有数据库对象名称必须使用小写字母并用下划线分割
2. 所有数据库对象名称禁止使用 `MySQL` 保留关键字（如果表名中包含关键字查询时，需要将其用单引号括起来）
3. 数据库对象的命名要能做到见名识意，并且最后不要超过 32 个字符
4. 临时库表必须以 `tmp_` 为前缀并以日期为后缀，备份表必须以 `bak_` 为前缀并以日期 (时间戳) 为后缀
5. 所有存储相同数据的列名和列类型必须一致（一般作为关联列，如果查询时关联列类型不一致会自动进行数据类型隐式转换，会造成列上的索引失效，导致查询效率降低）

## 数据库字段规范

1. 优先选择符合存储需要的最小的数据类型
2. 使用 TIMESTAMP(4 个字节) 或 DATETIME 类型 (8 个字节) 存储时间
    - TIMESTAMP 存储的时间范围 1970-01-01 00:00:01 ~ 2038-01-19-03:14:07
    - TIMESTAMP 占用 4 字节和 INT 相同，但比 INT 可读性高
    - 超出 TIMESTAMP 取值范围的使用 DATETIME 类型存储
3. 同财务相关的金额类数据必须使用 `decimal` 类型
    - 非精准浮点：`float,double`
    - 精准浮点：`decimal`
4. `TEXT` 或 `BLOB` 类型只能使用前缀索引
5. 字段语义化
    - 见名知意
6. 字段长度限制
    - 长度尽可能在 10 以下，如果超出，那你的字段已包含多个含义
7. 字段的默认值
    - 尽可能把所有列定义为 `NOT NULL`；字符类型默认为 ''，数字类型默认为 0，**且不能影响业务逻辑**

## 数据库索引规范

1. 限制每张表上的索引数量,建议单张表索引不超过 5 个
2. 对于频繁的查询优先考虑使用覆盖索引
3. 避免建立冗余索引和重复索引
    - 增加了查询优化器生成执行计划的时间
4. 每个 `Innodb` 表必须有个主键
5. 索引 SET 规范
    - 尽量避免使用外键约束
6. 命名
    - 主键约束: pk 结尾，_pk;
    - 一般外键: index 结尾，_index;
    - unique 约束: _uk 结尾，uk;
    - check 约束:  _ck 结尾，ck;
    - 外键约束:  _fk 结尾，以 pri 连接本表与主表，_pri_fk;

### 建议

1. 索引列的选择
    - 出现在 SELECT、UPDATE、DELETE 语句的 WHERE 从句中的列
    - 包含在 ORDER BY、GROUP BY、DISTINCT 中的字段
    - 并不要将符合 1 和 2 中的字段的列都建立一个索引， 通常将 1、2 中的字段建立联合索引效果更好
    - 多表 join 的关联列
2. 索引列顺序的选择
    - 区分度最高的放在联合索引的最左侧（区分度=列中不同值的数量/列的总行数）
    - 尽量把字段长度小的列放在联合索引的最左侧（因为字段长度越小，一页能存储的数据量越大，IO 性能也就越好）
    - 使用最频繁的列放到联合索引的左侧（这样可以比较少的建立一些索引）

## 数据库使用规范

1. 避免数据类型的隐式转换

2. 充分利用表上已经存在的索引

3. 在宽表、大表中，禁止使用 `SELECT *` 必须使用 `SELECT` 查询

4. 避免使用子查询，可以把子查询优化为 `join` 操作

5. 避免使用 `JOIN` 关联太多的表

6. 减少同数据库的交互次数

7. 对应同一列进行 `or` 判断时，使用 `in` 代替 `or`

8. 禁止使用 order by rand() 进行随机排序

9. `WHERE` 从句中禁止对列进行函数转换和计算

    - 不推荐

      ```sql
      where date(create_time)='20190101'
      ```
    
    - 推荐 

      ```sql
      where create_time >= '20190101' and create_time < '20190102'
      ```



10. 在明显不会有重复值时使用 `UNION ALL` 而不是 `UNION`

11. 拆分复杂的大 `SQL` 为多个小 `SQL`

